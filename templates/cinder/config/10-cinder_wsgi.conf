{{ range $endpt, $vhost := .VHosts }}
# {{ $endpt }} vhost {{ $vhost.ServerName }} configuration
<VirtualHost *:8776>
  ServerName {{ $vhost.ServerName }}

  ## Set DocumentRoot and Directory permissions only if the path exists
  <If "-d '/var/www/cgi-bin/cinder'">
    ## Vhost docroot
    DocumentRoot "/var/www/cgi-bin/cinder"

    ## Directories, there should at least be a declaration for /var/www/cgi-bin/cinder
    <Directory "/var/www/cgi-bin/cinder">
      Options -Indexes +FollowSymLinks +MultiViews
      AllowOverride None
      Require all granted
    </Directory>
  </If>

  Timeout {{ $.TimeOut }}

  ## Logging
  ErrorLog /dev/stdout
  ServerSignature Off
  CustomLog /dev/stdout combined

{{- if $vhost.TLS }}
  SetEnvIf X-Forwarded-Proto https HTTPS=1

  ## SSL directives
  SSLEngine on
  SSLCertificateFile      "{{ $vhost.SSLCertificateFile }}"
  SSLCertificateKeyFile   "{{ $vhost.SSLCertificateKeyFile }}"
{{- end }}

  ## WSGI configuration
  WSGIApplicationGroup %{GLOBAL}
  WSGIDaemonProcess {{ $endpt }} display-name={{ $endpt }} group=cinder processes=4 threads=1 user=cinder
  WSGIProcessGroup {{ $endpt }}
  ## Conditionally set the WSGIScriptAlias based on file existence
  <If "-f '/usr/lib/python3.12/site-packages/cinder/wsgi/api.py'">
    WSGIScriptAlias / "/usr/lib/python3.12/site-packages/cinder/wsgi/api.py"
  </If>
  <ElseIf "-f '/usr/lib/python3.9/site-packages/cinder/wsgi/api.py'">
    WSGIScriptAlias / "/usr/lib/python3.9/site-packages/cinder/wsgi/api.py"
  </ElseIf>
  <Else>
    ## Fallback to the original path if neither python version is found
    WSGIScriptAlias / "/var/www/cgi-bin/cinder/cinder-wsgi"
  </Else>
  WSGIPassAuthorization On
</VirtualHost>
{{ end }}
